service: mtc-backend

frameworkVersion: "3.40.0"

plugins:
  - serverless-appsync-plugin

provider:
  name: aws
  runtime: nodejs20.x
  profile: mtc-pierre
  region: us-west-1
  environment:
    AWS_ACCOUNT_ID: ${aws:accountId}

appSync:
  name: mtc
  logging:
    level: ALL
    retentionInDays: 14
  authentication:
    type: OPENID_CONNECT
    config:
      issuer: https://movementtocontact.us.auth0.com
      clientId: P6CqYvcXoqxuAzCiHGLe9hT3ImqXhjDb
  schema: schema.graphql

  dataSources:
    NONE:
      type: NONE
    mtcProdClient:
      type: AMAZON_DYNAMODB
      config:
        tableName: mtc-prod-client
        serviceRoleArn:
          Fn::GetAtt: [AppSyncLambdaServiceRole, Arn]
    mtcProdUser:
      type: AMAZON_DYNAMODB
      config:
        tableName: mtc-prod-user
        serviceRoleArn:
          Fn::GetAtt: [AppSyncLambdaServiceRole, Arn]
    mtcProdWorkspace:
      type: AMAZON_DYNAMODB
      config:
        tableName: mtc-prod-workspace
        serviceRoleArn:
          Fn::GetAtt: [AppSyncLambdaServiceRole, Arn]
    mtcProdInteraction:
      type: AMAZON_DYNAMODB
      config:
        tableName: mtc-prod-interaction
        serviceRoleArn:
          Fn::GetAtt: [AppSyncLambdaServiceRole, Arn]

  pipelineFunctions:
    createInteractionResolveOrCreateClient:
      dataSource: mtcProdClient
      code: pipelines/resolveOrCreateClient.ts
    createInteractionRecord:
      dataSource: mtcProdInteraction
      code: pipelines/createInteraction.ts

  resolvers:
    - ${file(resolvers/client/_client.yml)}
    - ${file(resolvers/interaction/_interaction.yml)}
    - ${file(resolvers/user/_user.yml)}
    - ${file(resolvers/workspace/_workspace.yml)}

resources:
  Resources:
    AppSyncLambdaServiceRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: mtc_appsync_lambda_service_role
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: appsync.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: AllowAllAccess
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action: "*"
                  Resource: "*"
